<div class="dashboard-page">

    <!-- Header -->
    <header class="page-header">
        <div class="header-left">
            <h1 class="page-title">Business Analytics</h1>
            <p class="page-subtitle">Performance metrics and insights</p>
        </div>
        <div class="header-actions">
            <!-- Date Picker (Mock) -->
            <div class="date-picker-mock">
                <span class="material-symbols-outlined">calendar_today</span>
                <span>{{ currentMonth | date:'MMMM y' }}</span>
                <span class="material-symbols-outlined">arrow_drop_down</span>
            </div>

            <button class="btn btn-primary" (click)="refreshData()">
                <span class="material-symbols-outlined spin-on-hover">refresh</span>
                Refresh Data
            </button>
        </div>
    </header>

    <!-- Content Area -->
    <div class="content-wrapper">

        <!-- Tabs -->
        <div class="tabs-header">
            <button class="tab-btn" [class.active]="activeTab === 'overview'" (click)="setActiveTab('overview')">
                <span class="material-symbols-outlined">bar_chart</span>
                Overview
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'ai'" (click)="setActiveTab('ai')">
                <span class="material-symbols-outlined">psychology</span>
                AI Insights
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'history'" (click)="setActiveTab('history')">
                <span class="material-symbols-outlined">receipt_long</span>
                History
            </button>
            <button class="tab-btn" [class.active]="activeTab === 'expenses'" (click)="setActiveTab('expenses')">
                <span class="material-symbols-outlined">payments</span>
                Expenses
            </button>
        </div>

        <!-- TAB: OVERVIEW -->
        <div class="tab-content" *ngIf="activeTab === 'overview'">

            <!-- KPI Grid -->
            <div class="kpi-grid">
                <!-- Card 1: Revenue -->
                <div class="kpi-card">
                    <div class="kpi-top">
                        <span class="kpi-label">Total Revenue</span>
                        <span class="badge badge-green">
                            <span class="material-symbols-outlined text-xs">trending_up</span>
                            Live
                        </span>
                    </div>
                    <h3 class="kpi-value">{{ salesMetrics.totalSalesValue | currency:'NGN':'symbol-narrow' }}</h3>
                    <p class="kpi-sub">Total recorded sales</p>
                </div>

                <!-- Card 2: Units Sold -->
                <div class="kpi-card">
                    <div class="kpi-top">
                        <span class="kpi-label">Units Sold</span>
                        <span class="badge badge-blue">
                            <span class="material-symbols-outlined text-xs">inventory_2</span>
                        </span>
                    </div>
                    <h3 class="kpi-value">{{ salesMetrics.totalUnitsSold }}</h3>
                    <p class="kpi-sub">Items moved</p>
                </div>

                <!-- Card 3: Stock Value -->
                <div class="kpi-card">
                    <div class="kpi-top">
                        <span class="kpi-label">Inventory Value</span>
                    </div>
                    <h3 class="kpi-value">{{ metrics.totalValue | currency:'NGN':'symbol-narrow' }}</h3>
                    <p class="kpi-sub">Current assets on hand</p>
                </div>

                <!-- Card 4: Low Stock -->
                <div class="kpi-card">
                    <div class="kpi-top">
                        <span class="kpi-label">Stock Health</span>
                        <span class="badge badge-red" *ngIf="metrics.lowStock > 0">Alert</span>
                    </div>
                    <h3 class="kpi-value">{{ metrics.lowStock }}</h3>
                    <p class="kpi-sub">Items with low stock</p>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="chart-section">
                <!-- Revenue Chart Mock -->
                <div class="chart-card main-chart">
                    <div class="chart-header">
                        <h3>Sales Transactions</h3>
                        <p>Revenue flow over time</p>
                    </div>
                    <div class="chart-body placeholder-chart">
                        <!-- Visual representation of the SVG from design -->
                        <svg class="w-full h-full" preserveAspectRatio="none" viewBox="0 0 800 200">
                            <defs>
                                <linearGradient id="chartGradient" x1="0" x2="0" y1="0" y2="1">
                                    <stop offset="0%" stop-color="#3b82f6" stop-opacity="0.2" />
                                    <stop offset="100%" stop-color="#3b82f6" stop-opacity="0" />
                                </linearGradient>
                            </defs>
                            <path
                                d="M0,150 C100,100 200,180 300,120 C400,60 500,140 600,100 S700,60 800,150 L800,200 L0,200 Z"
                                fill="url(#chartGradient)" />
                            <path d="M0,150 C100,100 200,180 300,120 C400,60 500,140 600,100 S700,60 800,150"
                                fill="none" stroke="#3b82f6" stroke-width="3" />
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: AI INSIGHTS -->
        <div class="tab-content" *ngIf="activeTab === 'ai'">
            <div class="ai-report-container" *ngIf="aiReport; else noReport">
                <!-- Header -->
                <div class="report-header">
                    <div class="icon-box">
                        <span class="material-symbols-outlined">auto_awesome</span>
                    </div>
                    <div>
                        <h2>AI Stock Health Report</h2>
                        <p class="text-sm text-muted"> Period: {{ aiReport.report_period_start | date:'MMM d' }} - {{
                            aiReport.report_period_end | date:'MMM d' }}</p>
                    </div>
                </div>

                <!-- Summary Section -->
                <div class="report-section summary-box">
                    <h3>Executive Summary</h3>
                    <p>{{ aiReport.summary }}</p>
                </div>

                <!-- Metrics Grid -->
                <div class="report-metrics-grid" *ngIf="aiReport.stock_movement">
                    <div class="metric-box bg-green-50">
                        <span class="label">Total Items Added</span>
                        <span class="value text-green">+{{ aiReport.stock_movement.total_items_added }}</span>
                    </div>
                    <div class="metric-box bg-blue-50">
                        <span class="label">Total Items Sold</span>
                        <span class="value text-blue">-{{ aiReport.stock_movement.total_items_sold }}</span>
                    </div>
                    <div class="metric-box bg-yellow-50" *ngIf="aiReport.mismatch_records">
                        <span class="label">Discrepancies</span>
                        <span class="value text-yellow">{{ aiReport.mismatch_records.length }}</span>
                    </div>
                </div>

                <!-- Actions & Mismatches -->
                <div class="report-columns">
                    <!-- Recommendations -->
                    <div class="col" *ngIf="aiReport.recommendations?.length">
                        <h4>üí° Strategic Recommendations</h4>
                        <ul class="styled-list check-list">
                            <li *ngFor="let tip of aiReport.recommendations">{{ tip }}</li>
                        </ul>
                    </div>

                    <!-- Mismatches -->
                    <div class="col" *ngIf="aiReport.mismatch_records?.length">
                        <h4>‚ö†Ô∏è Discrepancy Alerts</h4>
                        <ul class="styled-list alert-list">
                            <li *ngFor="let m of aiReport.mismatch_records">
                                <div class="alert-item">
                                    <strong>{{ m.product }}</strong>
                                    <span class="diff-tag">{{ m.difference }} diff</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
            <ng-template #noReport>
                <div class="empty-state">
                    <span class="material-symbols-outlined icon-lg">smart_toy</span>
                    <p>No AI analysis generated yet.</p>
                </div>
            </ng-template>
        </div>

        <!-- TAB: HISTORY LOGS (SALES LEDGER) -->
        <div class="tab-content" *ngIf="activeTab === 'history'">

            <!-- 1. Financial Snapshot Cards -->
            <div class="financial-cards-row">
                <div class="fin-card bg-blue-50 border-blue-200">
                    <span class="label text-blue-800">Total Revenue</span>
                    <span class="value text-blue-900">{{ financials.totalRevenue | currency:'NGN':'symbol-narrow'
                        }}</span>
                </div>

                <div class="fin-card bg-green-50 border-green-200">
                    <span class="label text-green-800">üíµ Cash at Hand</span>
                    <span class="value text-green-900">{{ financials.cashAtHand | currency:'NGN':'symbol-narrow'
                        }}</span>
                </div>

                <div class="fin-card bg-indigo-50 border-indigo-200">
                    <span class="label text-indigo-800">üè¶ Bank/Transfer</span>
                    <span class="value text-indigo-900">{{ financials.bankTransfer | currency:'NGN':'symbol-narrow'
                        }}</span>
                </div>
            </div>

            <div class="table-card mt-6">
                <!-- 2. Filters & Toolbar -->
                <div class="card-header-row toolbar-wrap">
                    <div class="filters-group">
                        <!-- Date -->
                        <div class="filter-item">
                            <label>Date:</label>
                            <input type="month" [(ngModel)]="filters.date" (change)="loadHistory()"
                                class="form-input-sm">
                        </div>

                        <!-- Staff -->
                        <div class="filter-item">
                            <select [(ngModel)]="filters.staff" (change)="loadHistory()" class="form-select-sm">
                                <option value="all">All Staff</option>
                                <option *ngFor="let s of staffList" [value]="s.id">{{ s.name }}</option>
                            </select>
                        </div>

                        <!-- Method -->
                        <div class="filter-item">
                            <select [(ngModel)]="filters.payment" (change)="loadHistory()" class="form-select-sm">
                                <option value="all">All Methods</option>
                                <option value="cash">Cash</option>
                                <option value="transfer">Transfer</option>
                                <option value="card">POS/Card</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 3. Invoice Table (Desktop) -->
                <div class="desktop-view">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Receipt #</th>
                                <th>Staff</th>
                                <th>Items Summary</th>
                                <th class="text-right">Total Amount</th>
                                <th class="text-center">Method</th>
                                <th class="text-center">Status</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let sale of groupedSales" (click)="viewReceipt(sale)"
                                class="cursor-pointer hover-bg">
                                <td class="text-muted">{{ sale.time }}</td>
                                <td class="font-mono text-primary font-bold">{{ sale.invoice_id }}</td>
                                <td>
                                    <div class="flex items-center gap-2">

                                        <span class="text-sm">{{ sale.staff_name }}</span>
                                    </div>
                                </td>
                                <td class="text-truncate max-w-200" title="{{sale.item_summary}}">
                                    {{ sale.item_summary }}
                                </td>
                                <td class="text-right font-bold text-lg">
                                    {{ sale.total | currency:'NGN':'symbol-narrow' }}
                                </td>
                                <td class="text-center">
                                    <span class="badge" [class.badge-green]="sale.payment_method === 'cash'"
                                        [class.badge-blue]="sale.payment_method === 'transfer' || sale.payment_method === 'card'">
                                        {{ sale.payment_method | uppercase }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <span
                                        *ngIf="sale.status === 'void' || sale.status === 'voided' || sale.status === 'rejected'"
                                        class="badge badge-red">VOIDED</span>
                                    <span
                                        *ngIf="sale.status !== 'void' && sale.status !== 'voided' && sale.status !== 'rejected'"
                                        class="badge badge-gray text-xs">OK</span>
                                </td>
                                <td class="text-center">
                                    <button class="btn-icon">
                                        <span class="material-symbols-outlined">visibility</span>
                                    </button>
                                </td>
                            </tr>
                            <tr *ngIf="groupedSales.length === 0">
                                <td colspan="8" class="text-center py-8 text-muted">
                                    No sales found for this date/filter.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Sales Mobile Card View -->
                <div class="mobile-view p-4">
                    <div class="sale-card-mobile" *ngFor="let sale of groupedSales" (click)="viewReceipt(sale)">
                        <div class="s-card-top">
                            <div class="s-meta">
                                <span class="s-time">{{ sale.time }}</span>
                                <span class="s-id">{{ sale.invoice_id }}</span>
                            </div>
                            <span class="badge text-xs" [class.badge-green]="sale.payment_method === 'cash'"
                                [class.badge-blue]="sale.payment_method !== 'cash'">
                                {{ sale.payment_method | uppercase }}
                            </span>
                        </div>
                        <div class="s-card-mid">
                            <p class="s-items">{{ sale.item_summary }}</p>
                        </div>
                        <div class="s-card-bot">
                            <span class="s-staff">{{ sale.staff_name }}</span>
                            <span class="s-total">{{ sale.total | currency:'NGN':'symbol-narrow' }}</span>
                        </div>
                        <div *ngIf="sale.status === 'voided'" class="s-void-overlay">VOIDED</div>
                    </div>
                    <div *ngIf="groupedSales.length === 0" class="text-center py-4 text-muted">
                        No sales found.
                    </div>
                </div>

            </div>
        </div>

        <!-- TAB: EXPENSES ANALYTICS -->
        <div class="tab-content" *ngIf="activeTab === 'expenses'">

            <!-- 1. Expense KPI Cards -->
            <div class="financial-cards-row">
                <div class="fin-card bg-orange-50 border-orange-200">
                    <span class="label text-orange-800">Total Expenses</span>
                    <span class="value text-orange-900">{{ expenseMetrics.totalSpent | currency:'NGN':'symbol-narrow'
                        }}</span>
                    <span class="sub text-orange-600">Goods + Logistics</span>
                </div>

                <div class="fin-card bg-purple-50 border-purple-200">
                    <span class="label text-purple-800">Cost of Goods</span>
                    <span class="value text-purple-900">{{ expenseMetrics.goodsCost | currency:'NGN':'symbol-narrow'
                        }}</span>
                </div>

                <div class="fin-card bg-teal-50 border-teal-200">
                    <span class="label text-teal-800">Logistics Spent</span>
                    <span class="value text-teal-900">{{ expenseMetrics.logisticsCost | currency:'NGN':'symbol-narrow'
                        }}</span>
                </div>

                <div class="fin-card bg-gray-50 border-gray-200">
                    <span class="label text-gray-800">Net Profit</span>
                    <span class="value" [class.text-green-600]="expenseMetrics.netProfit >= 0"
                        [class.text-red-600]="expenseMetrics.netProfit < 0">
                        {{ expenseMetrics.netProfit | currency:'NGN':'symbol-narrow' }}
                    </span>
                </div>
            </div>

            <div class="table-card mt-6">
                <!-- Toolbar -->
                <div class="card-header-row toolbar-wrap">
                    <div class="filters-group">
                        <h3 class="mr-4">Expense Log</h3>
                        <!-- Date -->
                        <div class="filter-item">
                            <label>Date:</label>
                            <input type="month" [(ngModel)]="filters.date" (change)="loadExpenses()"
                                class="form-input-sm">
                        </div>
                    </div>
                </div>

                <!-- Expenses Table (Desktop) -->
                <div class="desktop-view">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Product</th>
                                <th class="text-right">Qty Added</th>
                                <th class="text-right">Unit Cost</th>
                                <th class="text-right">Goods Cost</th>
                                <th class="text-right">Logistics</th>
                                <th class="text-right">Total Entry Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let exp of expenses" class="hover-bg">
                                <td class="text-muted">{{ exp.created_at | date:'short' }}</td>
                                <td>
                                    <div class="font-medium">{{ exp.products?.name }}</div>
                                    <div class="text-xs text-muted">{{ exp.products?.category }}</div>
                                </td>
                                <td class="text-right">
                                    {{ exp.quantity }} {{ exp.unit_type }}
                                </td>
                                <td class="text-xs text-right text-muted">
                                    {{ exp.unit_cost | currency:'NGN':'symbol-narrow' }}
                                </td>
                                <td class="text-right">
                                    {{ exp.total_cost | currency:'NGN':'symbol-narrow' }}
                                </td>
                                <td class="font-medium text-right text-teal-700">
                                    {{ (exp.logistics_fee || 0) | currency:'NGN':'symbol-narrow' }}
                                </td>
                                <td class="font-bold text-right text-orange-900">
                                    {{ ((exp.total_cost || 0) + (exp.logistics_fee || 0)) |
                                    currency:'NGN':'symbol-narrow'
                                    }}
                                </td>
                            </tr>
                            <tr *ngIf="expenses.length === 0">
                                <td colspan="8" class="text-center py-8 text-muted">
                                    No expense records found for this period.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Expenses Mobile Card View -->
                <div class="mobile-view p-4">
                    <div class="exp-card-mobile" *ngFor="let exp of expenses">
                        <div class="e-card-top">
                            <span class="e-date">{{ exp.created_at | date:'shortDate' }}</span>
                            <span class="e-total">{{ ((exp.total_cost || 0) + (exp.logistics_fee || 0)) |
                                currency:'NGN':'symbol-narrow' }}</span>
                        </div>
                        <div class="e-card-mid">
                            <div class="e-prod">
                                <span class="font-medium">{{ exp.products?.name }}</span>
                                <span class="e-qty text-muted">{{ exp.quantity }} {{ exp.unit_type }}</span>
                            </div>
                        </div>
                        <div class="e-card-bot">
                            <span class="e-log">Logistics: {{ (exp.logistics_fee || 0) | currency:'NGN':'symbol-narrow'
                                }}</span>
                            <span class="e-cost">Goods: {{ exp.total_cost | currency:'NGN':'symbol-narrow' }}</span>
                        </div>
                    </div>
                    <div *ngIf="expenses.length === 0" class="text-center py-4 text-muted">
                        No expenses found.
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>