<div class="dashboard-page">
    <!-- Header -->
    <div class="page-header">
        <div>
            <div class="breadcrumb">Overview / Dashboard</div>
            <h1 class="page-title">Owner Dashboard</h1>
            <p class="page-subtitle">Welcome back, {{ name }}! Here is your daily overview.</p>
        </div>

        <div class="header-actions">
            <div class="notification-wrapper">
                <button class="btn btn-icon" (click)="toggleNotifications()">
                    <span class="material-symbols-outlined">notifications</span>
                    <span class="badge" *ngIf="notifications.length > 0">{{ notifications.length }}</span>
                </button>

                <div class="dropdown-menu" *ngIf="showDropdown">
                    <div class="dropdown-header">Notifications</div>
                    <div class="dropdown-body">
                        <div *ngFor="let n of notifications" class="dropdown-item" (click)="onNotificationClick(n)">
                            <div class="item-icon">
                                <span class="material-symbols-outlined" [class.text-red]="n.type === 'alert'">
                                    {{ n.type === 'alert' ? 'error' : 'info' }}
                                </span>
                            </div>
                            <div class="item-content">
                                <strong>{{ n.title }}</strong>
                                <p>{{ n.message }}</p>
                                <small>{{ n.created_at | date: 'shortTime' }}</small>
                            </div>
                        </div>
                        <div class="empty-state" *ngIf="notifications.length === 0">
                            No new notifications
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-outline" (click)="handleLogout()">
                <span class="material-symbols-outlined">logout</span>
                Logout
            </button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-content">
                <p class="stat-label">Inventory Value</p>
                <h3 class="stat-value">{{ metrics.totalValue | currency: '₦' }}</h3>
                <span class="stat-badge badge-blue">Total Assets</span>
            </div>
            <div class="stat-icon icon-blue">
                <span class="material-symbols-outlined">payments</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-content">
                <p class="stat-label">Total Revenue</p>
                <h3 class="stat-value">{{ salesMetrics.totalSalesValue | currency: '₦' }}</h3>
                <span class="stat-badge badge-green">Sales</span>
            </div>
            <div class="stat-icon icon-green">
                <span class="material-symbols-outlined">attach_money</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-content">
                <p class="stat-label">Low Stock</p>
                <h3 class="stat-value">{{ metrics.lowStock }}</h3>
                <span class="stat-badge badge-amber" *ngIf="metrics.lowStock > 0">Attention Needed</span>
                <span class="stat-badge badge-green" *ngIf="metrics.lowStock === 0">Healthy</span>
            </div>
            <div class="stat-icon icon-amber">
                <span class="material-symbols-outlined">warning</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-content">
                <p class="stat-label">Total Items</p>
                <h3 class="stat-value">{{ metrics.totalItems }}</h3>
                <span class="stat-badge badge-purple">SKUs</span>
            </div>
            <div class="stat-icon icon-purple">
                <span class="material-symbols-outlined">inventory_2</span>
            </div>
        </div>
    </div>

    <div class="content-grid">
        <!-- Stock Management Column -->
        <div class="grid-column">
            <!-- Manage Stock Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Manage Stock</h3>
                </div>
                <div class="card-body">
                    <div class="form-instruction-banner">
                        <span class="material-symbols-outlined">info</span>
                        <p>
                            To update stock for an <strong>existing product</strong>, select it from the dropdown.
                            To add a <strong>new item</strong>, keep "-- New Product --" selected and enter the name
                            below.
                        </p>
                    </div>

                    <form [formGroup]="stockForm" (ngSubmit)="onSubmit()" class="vertical-form">
                        <div class="form-group">
                            <label>Update Stock for an existing product</label>
                            <select formControlName="product_id" class="form-select">
                                <option value="">-- New Product --</option>
                                <option *ngFor="let p of products" [value]="p.id">{{ p.name }}</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Enter New Product Name</label>
                            <input type="text" formControlName="name" class="form-input"
                                placeholder="e.g. Frozen Chicken">
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Unit Type</label>
                                <select formControlName="unit_type" class="form-select">
                                    <option value="kg">Kilograms (kg)</option>
                                    <option value="box">Box / Carton</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Quantity</label>
                                <input type="number" formControlName="quantity" class="form-input" placeholder="0">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Unit Cost</label>
                                <div class="input-prefix">
                                    <span>₦</span>
                                    <input type="number" formControlName="unit_cost" class="form-input"
                                        placeholder="0.00">
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Logistics Fee (₦)</label>
                                <div class="input-prefix">
                                    <span>₦</span>
                                    <input type="number" formControlName="logistics_fee" class="form-input"
                                        placeholder="0.00">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Selling Price (per Unit)</label>
                                <div class="input-prefix">
                                    <span>₦</span>
                                    <input type="number" formControlName="unit_price" class="form-input"
                                        placeholder="0.00">
                                </div>
                            </div>
                        </div>

                        <div class="form-group" *ngIf="stockForm.get('unit_type')?.value === 'box'">
                            <label>Total Weight (KG)</label>
                            <input type="number" formControlName="total_weight" class="form-input"
                                placeholder="Total weight">
                            <small class="hint">Required for box items.</small>
                        </div>

                        <button type="submit" class="btn btn-primary full-width" [disabled]="!stockForm.valid">
                            Record Stock
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Live Operations Column -->
        <div class="grid-column">
            <!-- Live Activity Feed -->
            <div class="card">
                <div class="card-header highlight-header">
                    <div class="header-with-icon">
                        <span class="material-symbols-outlined icon-pulse">ecg_heart</span>
                        <h3 class="card-title">Live Activity</h3>
                    </div>
                    <button class="btn-icon-sm" (click)="loadData()">
                        <span class="material-symbols-outlined">refresh</span>
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="activity-feed">
                        <div *ngFor="let act of recentActivity" class="feed-item">
                            <div class="feed-icon" [class.bg-green]="act.type === 'sale'"
                                [class.bg-blue]="act.type === 'stock'">
                                <span class="material-symbols-outlined text-xs">
                                    {{ act.type === 'sale' ? 'payments' : 'inventory_2' }}
                                </span>
                            </div>
                            <div class="feed-content">
                                <p class="feed-text">
                                    <strong>{{ act.user }}</strong>
                                    {{ act.type === 'sale' ? 'sold' : 'added' }}
                                    <span class="text-highlight">{{ act.description }}</span>
                                </p>
                                <span class="feed-time">{{ act.time }}</span>
                            </div>
                            <div class="feed-amount" *ngIf="act.amount">
                                +{{ act.amount | currency:'NGN':'symbol-narrow' }}
                            </div>
                        </div>
                        <div *ngIf="recentActivity.length === 0" class="empty-state">
                            No recent activity.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Urgent Alerts / Low Stock -->
            <div class="card mt-4" *ngIf="metrics.lowStock > 0">
                <div class="card-header">
                    <h3 class="card-title text-red">⚠️ Restock Needed</h3>
                </div>
                <div class="card-body p-0">
                    <div class="stock-list">
                        <div *ngFor="let p of lowStockItems" class="stock-item">
                            <div class="item-info">
                                <span class="item-name">{{ p.name }}</span>
                                <span class="item-meta text-red font-bold">{{ p.unit }} left</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>